---
title: 'Analyses'
author: "KN"
date: '`r Sys.Date()`'
output: html_document
---

For output from ibex farm 

About
=====
- SPR conducted at Lancers ibex, May 8, 2018  
- 116 participants    
- Target items: 24  
- Filler items: 48  
  


Conditions:  
Ds. Durative × Simplex    
Dr. Durative x Reduplicated  
Cs. Non-durative x Simplex  
Cr. Non-durative x Reduplicated  

[["Ds",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Dr",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらちら 見たので 先生が カンニングを 疑った。"}, "Question",  
{q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Cs",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],
[["Cr",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらちら 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],  





##### Load libraries

```{r}
#library(lme4)
library(lmerTest)
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape)
library(gdata)      
library(MASS)
```


##### Declare the expt name that is relevant.
```{r}
ex<-"e"

# critical region
criticalregion<-4

# how far from the critical region do you want the plot to cover?
crplus<-3

# plot legend（凡例）のならび順はデフォルトではアルファベット順
# 逆順にしたい場合はここを1にする
revorderA <- 1  # ab vs cd
revorderB <- 1  # ac vs bd
```


##### Load data:

```{r}
alldata<-read.csv("alldata.csv",header=T)
alldata<-alldata[,-1]
alldata$item<-as.numeric(alldata$item)
itemdata<-read.csv("itemdata.csv")
itemdata<-itemdata[,-1]
# 標準化（z値化）
# 注：scale()[,1]としているのは，scale()は行列を返すので，「列1だけ出力おねがい」という意味
itemdata$Itemvalue<-scale(itemdata$Itemvalue, center = T, scale = T)[,1]
alldata <- merge(alldata,itemdata,all=T);

```





Isolate the data from the relevant experiment
=============================================
```{r}
data<-subset(alldata,expt==ex)
unique(data$expt)
```


Subj exclusion
==============


##### before trimming
Subject number before trimming
```{r}
unique(data$subj)
length(unique(data$subj))
```


##### trim by CA

```{r}
data<-subset(data,SubjCA>=200/3)
unique(data$subj)
length(unique(data$subj))
```


##### trim by RTZS

```{r}
data<-subset(data,SubjRTZS<=3)
unique(data$subj)
length(unique(data$subj))
```


##### trim by RTmean

```{r}
data<-subset(data,SubjRTmean<=10000)
unique(data$subj)
length(unique(data$subj))
```



Reading time summary
====================

```{r}
rt_data<-data
```

##### Make sure factors are treated as factors
```{r}
rt_data$subj<-factor(rt_data$subj)
rt_data$expt<-factor(rt_data$expt)
rt_data$item<-factor(rt_data$item)
rt_data$cond<-factor(rt_data$cond)
rt_data$word<-factor(rt_data$word)
```

##### Correctly answered trials only? (trimincorrect)

Note: if you do this trimming at this point, it precedes the z-score computation.

```{r}
  rt_data<-subset(rt_data,correct==100)
```


rt trimming

```{r}
rt_data_notrim <- rt_data

rt_data<-subset(rt_data_notrim,rt>=150 & rt<=10000)

```

Generate z-scores for variable A using the scale() function
scale(A, center = TRUE, scale = TRUE)

Be aware that this z-score computation per region x cond cell is { before / after } the yes/no trimming.

```{r}
myRT <- c()
newdataframe <- c()
for(i in unique(rt_data$region)){   
  for(j in unique(rt_data$cond)){
    # abstract rt column in the region x cond cell
    myRT <- subset(rt_data, region==i & cond==j);
    # compute z-score; [,1]を付けるのはscale()が行列データを返すので列1だけ出力してという意味
    myRT$RxCzs <- scale(myRT$rt, center = T, scale = T)[,1];
    # 蓄積
    newdataframe<-rbind(newdataframe,myRT);
    }
}; 

rt_data <- merge(rt_data,newdataframe,all=T)
length(unique(rt_data$subj))
```


##### rt trimming based on RxCzs
```{r}
tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)

rt_data<-subset(rt_data,RxCzs<3)

tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)
mean(subset(rt_data,region==5&cond=="h")$rt)

```

```{r}
(length(rt_data_notrim$rt)-length(rt_data$rt))*100/length(rt_data_notrim$rt)
```


```{r}
tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)

RTlabel<-"RTs(ms)"
```

```{r}
# First, change the value of spilloverraw under lowerboundRT to the value of lowerboundRT because we do not overestimate the negative spillover effects
rt_data$spilloverraw[rt_data$spilloverraw<150]<-150

rt_data$spillover<-scale(rt_data$spilloverraw, center=T, scale=T)
```


## Summary (interim)

のちにtrimmingをする（かもしれない）ので，このファイルの最後でもういちどサマリーとプロットの最終盤を生成します。

##### Extract data for summary

###### Critical region plus 3
```{r}
rtg <- subset(rt_data,region<=criticalregion+crplus)

```


##### summary

```{r}
rt_data_summary <- ddply(rtg, .(cond,region), summarise, N=length(rt), mean=mean(rt), sd=sd(rt), se=sd/sqrt(N),ci=qt(0.975,df=N-1)*se)
```

##### Coding conditions for plot labels
```{r}
rt_data_summary$A<-ifelse(rt_data_summary$cond%in%c("Cr","Cs"),"Non-durative","Durative")
rt_data_summary$B<-ifelse(rt_data_summary$cond%in%c("Cr","Dr"),"Reduplicated","Simplex")
rt_data_summary$Conditions<-paste(rt_data_summary$A,rt_data_summary$B,sep=":")
rt_data_summary$B

# Change the order of the legend labels
if( revorderA == 1 ){  
  rt_data_summary$A<-factor(rt_data_summary$A, levels=rev(levels(factor(rt_data_summary$A))))}
if( revorderB == 1 ){  
  rt_data_summary$B<-factor(rt_data_summary$B, levels=rev(levels(factor(rt_data_summary$B))))
}


# Factor labels in the plots
Alabel<-"Temp Adverb"  
Blabel<-"Onomatopoeia"  

rt_data_summary
#rrt_data_summary
```


## Plots

See the following references for ggplot codes:

http://www.cookbook-r.com/Graphs/Shapes_and_line_types/

http://meme.biology.tohoku.ac.jp/students/iwasaki/rstats/ggplot2.html


##### Mean RTs
Base
```{r}
g <- ggplot(rt_data_summary,aes(x=region,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(linetype=A))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Alabel)
```

Add points
```{r}
g <- g + geom_point(size=5,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(21,24,24,25))
g <- g + scale_fill_manual(values=c("white","black","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```



Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.3)
```

Adjust x-axis breaks and labels
```{r}
g <- g + scale_x_continuous(breaks=seq(1, 8, by=1),labels=c("Subj", "Temp Adv",
                              "Mod", "Onom", "Verb", "6","7","8"))

```

Create Theme

```{r}
g <- g + theme(      
                 # 背景を消す
                 panel.background = element_rect(fill = "white"),
                 panel.border = element_blank(), axis.line = element_line(),
                 # 凡例の設定
                 legend.position    = c(1, 1),
                 legend.justification = c(1,1),
                 #legend.title = element_blank(), 
                 legend.title = element_text(family = "Times", size = 15),
                 legend.text = element_text(size = 15, family="Times"),
                 legend.key = element_blank(), 
                 # テキスト形式の設定
                 axis.title.x = element_text(family = "Times", size = 20), 
                 axis.title.y = element_text(family = "Times",size = 20), 
                 axis.text.x = element_text(angle =   45, size = 15, hjust = 1,family = "Times"), 
                 axis.text.y = element_text(size = 15, hjust = 0.5, family = "Times"),
              )

```


Adjust appearance
```{r}
#g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
#g <- g + theme(base_size=20, base_family="Times", axis.text.x = element_text(angle = 45, hjust = 1))
g <- g + labs(x="Region", y="RT (ms)")
print(g)
```


##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(21,24,24,25))
g <- g + scale_fill_manual(values=c("white","black","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal adverb", y=RTlabel)
print(g)
```




##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion+1)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(21,24,24,25))
g <- g + scale_fill_manual(values=c("white","black","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal abverb", y=RTlabel)
print(g)
```



##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion+2)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(21,24,24,25))
g <- g + scale_fill_manual(values=c("white","black","black","white"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal adverb", y=RTlabel)
print(g)
```




### Analysis 



Coding factors 
-------------------------------

##### CONDITIONS:

```{r}
rt_data$Adv<-ifelse(rt_data$cond%in%c("Dr","Ds"),1,-1)
rt_data$Onom<-ifelse(rt_data$cond%in%c("Ds","Cs"),1,-1)

# For pairwise comparisons
rt_data$simplexVSredup_dur <-ifelse(rt_data$Adv==1,
                          ifelse(rt_data$Onom==1,1,-1),
                          0)
rt_data$simplexVSredup_nondur <-ifelse(rt_data$Adv==-1,
                          ifelse(rt_data$Onom==1,1,-1),
                          0)
rt_data$durVSnondur_simplex <-ifelse(rt_data$Onom==1,
                          ifelse(rt_data$Adv==1,1,-1),
                          0)
rt_data$durVSnondur_redup <-ifelse(rt_data$Onom==-1,
                          ifelse(rt_data$Adv==1,1,-1),
                          0)



```

rt_data check
```{r}
dc <- subset(rt_data,cond=="Cr",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Cs",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Dr",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Ds",c(cond,word,Adv,Onom))
head(dc, n=7)

```




##### Make sure factors are treated as factors
```{r}
rt_data$subj<-factor(rt_data$subj)
rt_data$expt<-factor(rt_data$expt)
rt_data$item<-factor(rt_data$item)
rt_data$cond<-factor(rt_data$cond)
rt_data$word<-factor(rt_data$word)
```

#### Critical(Onomatopoeia) region 
```{r}
cregion<-subset(rt_data,region==criticalregion)
```

##### Check words
```{r}
sort(unique(cregion$word))
```


##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

(step_res <- step(mm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)


```




#### Verb region
```{r}
cregion<-subset(rt_data,region==criticalregion+1)
```

##### Check words
```{r}
sort(unique(cregion$word))
```



##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

(step_res <- step(mm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)

```




```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+Adv:Itemvalue+Onom:Itemvalue+Adv:Onom:Itemvalue+Itemvalue+
           (1+Adv+Onom+Adv:Onom|subj),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)
(step_res <- step(mm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)

```


#### Onom x itemvalue in non-durative

```{r}

mm<-lmer(rt~simplexVSredup_dur:Itemvalue+simplexVSredup_nondur:Itemvalue+Adv+Onom+Itemvalue+Adv:Itemvalue+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)
(step_res <- step(mm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)

```



##### Post hoc multiple pairwise comparisons to test the interaction
```{r}
mmm<-lmer(rt~simplexVSredup_dur+simplexVSredup_nondur+Adv+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mmm)

(step_res <- step(mmm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)


```

```{r}
mmm<-lmer(rt~durVSnondur_simplex+durVSnondur_redup+Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mmm)

(step_res <- step(mmm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)


```




#### Spillover region
```{r}
cregion<-subset(rt_data,region==criticalregion+2)
```

##### Check words
```{r}
sort(unique(cregion$word))
```


##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

(step_res <- step(mm, reduce.fixed = F))
final <- get_model(step_res)
summary(final)
anova(final)


```





