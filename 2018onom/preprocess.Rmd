---
title: 'Analyses'
author: "KN"
date: '`r Sys.Date()`'
output: html_document
---

For output from ibex farm 

About
=====
- SPR conducted at Lancers ibex, May 8, 2018  
-  participants    
- Target items: 24  
- Filler items: 48  
  


Conditions:  
Ds. Durative × Simple    
Dr. Durative x Reduplicated  
Cs. Control x Simple  
Cr. Control x Reduplicated  

[["Ds",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Dr",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらちら 見たので 先生が カンニングを 疑った。"}, "Question",  
{q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Cs",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],
[["Cr",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらちら 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],  



Retrieve RT data into alldata
=============================

最初にやるべきこと：resultファイルに対して以下のシェルコマンドをかける。（Rでも同等のことはできるが，shellの方がの方が簡単）

アウトプットアウトプットとしてr.csvというファイルができる。

Use shell commands to:  
- convert the first line of results.csv to a header line;  
- delete all the comment lines:  
- delete all the practice items;  

sed "1s/#/time,subjid,controller,no,element,expt,item,region,word,rt,newline,sentence/g" results > r.csv;
sed '/^#/d' r.csv > r2.csv;
sed -e "/,practice/d" r2.csv > r.csv;
rm r2.csv




##### Load libraries

```{r}
#library(lme4) 
library(lmerTest)
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape)
library(gdata)      
library(MASS)
```


##### Load data:

```{r}
alldata<-read.csv("alldata_raw_minus_id.csv",header=T)

```


##### Subj age, language
regionのコラムにage, language, nameがあり，wordのコラムにそのvalueがあるので，それを抜き出し，subj 全体にexpandする。


```{r}
# Extract the question rows > select the relevant columns only
age<-subset(alldata,region=="age") %>%
  dplyr::select(time,subjid,word) 

# Rename column
names(age)[names(age)=="word"]<-"age"

# Merge cqdata with alldata.  
alldata <- merge(alldata,age,all=T)

# Extract the question rows > select the relevant columns only
language<-subset(alldata,region=="language") %>%
  dplyr::select(time,subjid,word) 

# Rename column
names(language)[names(language)=="word"]<-"language"

# Merge cqdata with alldata.  
alldata <- merge(alldata,language,all=T)




```

##### Check participants with language

```{r}
subset(language,language!="Japanese")

alldata<-subset(alldata,language=="Japanese")
```


##### Separate subject info:
```{r}
subjinfo <- subset(alldata, controller=="Form2")
alldata <- subset(alldata, controller!="Form2")
```





##### Create subj column


```{r}
# とりあえずtimeを入れることによって同一SubjIDを別subjとする
alldata$timeplussubjid <- paste(alldata$time,alldata$subjid)
alldata$subj <- as.numeric(factor(alldata$timeplussubjid))
```

##### Create code column and extract age data
Codeはregionに入っている

```{r}
codedata <- subset(alldata, expt=="code")
codedata$code <- codedata$region

# Check if there are subjects with identical SubjIDs
sum(duplicated(codedata$subjid))
codedata[duplicated(codedata$subjid),]

# Mark the duplicated subjid
dupsubjid <- unique(codedata$subjid[duplicated(codedata$subjid)])
if( length(dupsubjid) > 0 ){
  for(i in dupsubjid ){
    codedata$duplicatedsubjid[codedata$subjid==i] <- "*"
  }
}


# Check the duplicated subjids
codedata[which(codedata$duplicatedsubjid=="*"),]

# Age data
agedata <- codedata[c("subj","age")]

# Merge with alldata
codedata <- codedata[c("subj","code","duplicatedsubjid")]
alldata <- subset(alldata, expt!="code")
alldata <- merge(alldata,codedata,all=T)

```
##### Create cond column
exptにconditionが入っている場合，exptをcondコラムにコピーし，exptコラムをsimplifyする

```{r}
alldata$cond <- alldata$expt

```

```{r}
alldata$expt<-ifelse(alldata$expt!="gfiller","e","filler")
```




##### Make numeric numeric again
Note: `as.character` gets factors back to characters.  I don't know why but factors cannot get directly back to numeric.

```{r}
alldata$rt<-as.numeric(as.character(alldata$rt))
alldata$region<-as.numeric(as.character(alldata$region))
alldata$age<-as.numeric(as.character(alldata$age))
```

##### Age data

```{r}
summary(alldata$age)
```



##### Eliminate unwanted colums:
```{r}
alldata<-alldata[,c("subj","duplicatedsubjid","controller","expt","cond","item","no","region","word","rt","code","age","language")]
```


##### Create "spillover" column
#### Be sure that the package dplyr is loaded!!!  Otherwise, the lag function won't work properly

It's important to create spillover at this point because the order really matters.  

```{r}
# add one element to rt
spilloverraw <- c(0,alldata$rt)
# drop the last element 
spilloverraw <- spilloverraw[1:length(spilloverraw)-1]
# add to alldata
alldata$spilloverraw <- spilloverraw

# pos 0 and ? doesn't have a spillover
alldata$spilloverraw<-ifelse(alldata$region==1|alldata$controller=="Question",NA,alldata$spilloverraw)
head(alldata) %>%
dplyr::select(subj,expt,item,region,rt,spilloverraw)

# centering
alldata$spillover<-scale(alldata$spilloverraw, center=T, scale=F)

```


##### Exclude practice items

```{r}
alldata<-subset(alldata,expt!="practice")
```


##### create correct column
Questionがcorrect (1)かwrong (0)は，Questionのrtコラムにあるので，それを抜き出し，subj x no 全体にexpandする。なお，noは，stimulusの通し番号。


```{r}
# Extract the question rows > select the relevant columns only
cqdata<-subset(alldata,controller=="Question") %>%
  dplyr::select(subj,no,rt) 

# Rename "rt" as "correct"
names(cqdata)[names(cqdata)=="rt"]<-"correct"

# Merge cqdata with alldata.  
alldata <- merge(alldata,cqdata,all=T)

# Convert 1/0 to 100/0
alldata$correct <- alldata$correct *100

# We can delete the Question row now.
alldata <- subset(alldata, controller!="Question")
```



Subject analyses
================

##### 変数初期化
```{r}
subjdataframe = c(); 
```

RT mean per subject
-------------------

##### SubjのRT meanを計算して蓄積
```{r}

#tapply(tempdata$rt,tempdata$subj,mean)
subjdataframe<-ddply(alldata,.(subj),summarize,SubjRTmean=mean(rt,na.rm=T))
```


##### Each Subj RT meanのZ-scoreをdataframeに加える


```{r}
subjdataframe<-data.frame(subjdataframe, SubjRTZS=scale(subjdataframe$SubjRTmean));
```

##### asterisk columnを加える (outlier indication)
```{r}
subjdataframe<-data.frame(subjdataframe, RTmark=ifelse(subjdataframe$SubjRTZS>2.5, "*", " "));
```




Comprehension Accuracy per expt
----------------------------------
##### 変数初期化
```{r}
CAdataframe <- c(); 
myCA <- c()
myCAdataframe <- c()
```

##### Overall Comprehension Accuracy

```{r}
mean(subset(alldata,region==1)$correct,na.rm=T)
```

##### Each exptのComprehension Accuracy情報

```{r}
CAdataframe<-ddply(subset(alldata,region==1),.(expt),summarize,ExptMeanCA=mean(correct,na.rm=T))
```



##### Check data
```{r}
CAdataframe
```



Comprehension Accuracy per subject
----------------------------------

##### 変数初期化
```{r}
CAdataframe <- c(); 
myCA <- c()
myCAdataframe <- c()
summary(alldata)
```

##### Each subjのComprehension Accuracy情報を付加

```{r}
CAdataframe<-ddply(subset(alldata,region==1),.(subj),summarize,SubjCA=mean(correct))
```

##### Merge RT data + CA data
```{r}
subjdataframe<-merge(subjdataframe,CAdataframe,all=T)
```

##### asteriskを加える (outlier indication)
```{r}
subjdataframe<-data.frame(subjdataframe, CAmark=ifelse(subjdataframe$SubjCA<200/3, "**", ifelse(subjdataframe$SubjCA<70, "*" , " ")));
```

##### Age dataを加える

```{r}
subjdataframe<-merge(subjdataframe,agedata,all=T)
```




##### Round the values (for the sake of readability)
(Not used in the actual analyses)
```{r}
subjrounded <- subjdataframe[c("subj","SubjRTmean","SubjRTZS","RTmark","SubjCA","CAmark","age")]

subjrounded$SubjRTmean <- round(subjrounded$SubjRTmean,0)
subjrounded$SubjRTZS <- round(subjrounded$SubjRTZS,1)
sdata <- subjrounded

write.csv(sdata,file="subjdata.csv",quote=F)
```

##### Merge RT/CA data with `alldata`
```{r}
alldata <- merge(alldata,subjdataframe,all=T);
write.csv(alldata,file="alldata.csv",quote=F)
```


##### Check subject data
Note: ak's comprehension questions are not really questions so this grand mean does not make much sense.  
```{r}
sdata
```


##### Mean, median
```{r}
mean(subjdataframe$SubjCA)
median(subjdataframe$SubjCA)
```


##### Is there someone with accuracy below 70?
```{r}
bs <- sdata[which(sdata$SubjCA <70),]
bs[order(bs$SubjCA),]
```

##### Is there someone with slow mean RT?
```{r}
bs <- sdata[which(sdata$SubjRTZS >3),]
bs[order(bs$SubjRTmean),]
```







Comprehension Accuracy per subject x exp
----------------------------------

##### 変数初期化
```{r}
CAdataframe <- c(); 
myCA <- c()
myCAdataframe <- c()
```

##### Each subjのComprehension Accuracy情報を付加
```{r}
CAdataframe<-ddply(subset(alldata,region==1),.(expt,subj),summarize,SubjExptCA=mean(correct))
```

##### Exptごとのmeanとmedianを求める
```{r}
ddply(subset(alldata,region==1),.(expt),summarize,ExptCAmean=mean(correct))
```


##### Merge data with `alldata`
```{r}
alldata <- merge(alldata,CAdataframe,all=T);

# sort when messed up
alldata <- alldata[order(alldata$subj,alldata$expt,alldata$item,alldata$region),]
rownames(alldata) <- c(1:nrow(alldata))

write.csv(alldata,file="alldata.csv",quote=F)
```


##### Check subject data
expt x subj
```{r}
subjexptdata <- CAdataframe[order(CAdataframe$expt,CAdataframe$SubjExptCA),]
# rowname may be messed up; fix it
rownames(subjexptdata) <- c(1:nrow(subjexptdata))
subjexptdata
write.csv(subjexptdata,file="subjexptdata.csv",quote=F)
```


##### Is there someone with accuracy below 70?
```{r}
bs <- subjexptdata[which(subjexptdata$SubjExptCA <70),]
bs[order(bs$expt,bs$SubjExptCA),]
```




Subject number before trimming
```{r}
unique(alldata$subj)
length(unique(alldata$subj))
```


Comprehension Accuracy per exp x cond
----------------------------------

##### 変数初期化
```{r}
CAdataframe <- c(); 
myCA <- c()
myCAdataframe <- c()
```

##### Overall Comprehension Accuracy rates
```{r}
mean(subset(alldata,region==1)$correct)

```



```{r}
ddply(subset(alldata,region==1),.(expt),summarize,ExptCondCA=mean(correct))

```


