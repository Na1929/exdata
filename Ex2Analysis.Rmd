---
title: ''
author: "KN"
date: '`r Sys.Date()`'
output: html_document
---

For output from ibex farm 

About
=====
- SPR conducted at Lancers ibex, May 8, 2018  
- 116 participants    
- Target items: 24  
- Filler items: 48  
  


Conditions:  
Ds. Durative × Simple    
Dr. Durative x Reduplicated  
Cs. Non-durative x Simple  
Cr. Non-durative x Reduplicated  

[["Ds",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Dr",1], "DashedSentenceNoSpace",  
{s: "生徒が しばらく 黒板を ちらちら 見たので 先生が カンニングを 疑った。"}, "Question",  
{q: "生徒は黒板をしばらく見た。", hasCorrect:0}],
[["Cs",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらっと 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],
[["Cr",1], "DashedSentenceNoSpace",  
{s: "生徒が その時 黒板を ちらちら 見たので 先生が カンニングを 疑った。"},  
"Question", {q: "生徒は黒板をしばらく見た。", hasCorrect:1}],  





##### Load libraries

```{r}
#library(lme4)
library(lmerTest)
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape)
library(gdata)      
library(MASS)
```


##### Declare the expt name that is relevant.
```{r}
ex<-"e"

# critical region
criticalregion<-4

# how far from the critical region do you want the plot to cover?
crplus<-3

# plot legend（凡例）のならび順はデフォルトではアルファベット順
# 逆順にしたい場合はここを1にする
revorderA <- 0  # ab vs cd
revorderB <- 0  # ac vs bd


```


##### Trimming criteria
```{r}
# Trim bad subjects: data<-subset(data,SubjCA>=trimSubjCA)
# No trimming: trimSubjCA <- 0
trimSubjCA <- 200/3
# Trim bad subjects: data<-subset(data,SubjExptCA>=trimSubjExptCA)
# No trimming: trimSubjExptCA <- 0
trimSubjExptCA <- 0

# Trim slow subjects: data<-subset(data,SubjRTZS<trimSubjRTZS)
# (Virtually) No trimming: trimSubjRTZS <- 99
trimSubjRTZS <- 3

# Trim slow subjects: data<-subset(data,SubjRTmean<trimSubjRTmean)
# (Virtually) No trimming: trimSubjRTZS <- 10000
trimSubjRTmean <- 10000


# Trim incorrectly answered trials?  if( trimincorrect == 1 ){ rt_data<-subset(rt_data,correct==100) }
# No trimming: trimincorrect <- 0
trimincorrect <- 1

# Trim extreme RTs rt_data<-subset(rt_data_notrim,rt>=RTlowerbound & rt<=RTupperbound)
# (Virtually) No trimming: upperboundRT <- 100000
upperboundRT <- 10000
# No trimming: upperboundRT <- 100000
# No trimming: lowerboundRT <- 0
lowerboundRT <- 200

# Then RxC z-scores will be computed
# Trim based on zs in each condition x region cell d<-subset(rt_data,RxCzs<trimRxCzs)
# (Virtually) No trimming: trimRxCzs <- 99
trimRxCzs <- 3

# RT transformation
tf <- "none"  # No transformation
#tf <- "log"   # Log transformation
#tf <- "log10"  # Log10 transformation
#tf <- "negreciprocal" # Negative reciprocal *1000

# Want to center the spillover? (Usually yes)
spillovercentering <- 1

# Want to z-transform the spillover?
spilloverztransform <- 1

```


##### Load data:

```{r}
alldata<-read.csv("alldata.csv",header=T)
```


Isolate the data from the relevant experiment
=============================================
```{r}

alldata <- subset(alldata, expt!="intro")
alldata <- alldata[]
data<-subset(alldata,expt==ex)
unique(data$expt)
```

Isolate conditions 
=============================================
```{r}
#data<-subset(data,cond%in%c("a","b","d","e","f","h"))
#unique(data$cond)
```



Subj exclusion
==============


##### before trimming
Subject number before trimming
```{r}
unique(data$subj)
length(unique(data$subj))
```


##### trim by CA

```{r}
data<-subset(data,SubjCA>=trimSubjCA)
unique(data$subj)
length(unique(data$subj))
data<-subset(data,SubjExptCA>=trimSubjExptCA)
unique(data$subj)
length(unique(data$subj))
```


##### trim by RTZS

```{r}
data<-subset(data,SubjRTZS<=trimSubjRTZS)
unique(data$subj)
length(unique(data$subj))
```


##### trim by RTmean

```{r}
data<-subset(data,SubjRTmean<=trimSubjRTmean)
unique(data$subj)
length(unique(data$subj))
```



Reading time summary
====================

```{r}
rt_data<-data
```

##### Make sure factors are treated as factors
```{r}
rt_data$subj<-factor(rt_data$subj)
rt_data$expt<-factor(rt_data$expt)
rt_data$item<-factor(rt_data$item)
rt_data$cond<-factor(rt_data$cond)
rt_data$word<-factor(rt_data$word)
```

##### Correctly answered trials only? (trimincorrect)

Note: if you do this trimming at this point, it precedes the z-score computation.

```{r}
if( trimincorrect == 1 ){
  rt_data<-subset(rt_data,correct==100)
}
```

##### RT trimming?  
100msを切るRTが見受けられるのでさすがにカットしたほうが良いかと。
```{r}
subset(rt_data,rt<200 & region==1,c("expt","cond","region","rt"))
subset(rt_data,rt<200 & region==2,c("expt","cond","region","rt"))
subset(rt_data,rt<200 & region==3,c("expt","cond","region","rt"))
subset(rt_data,rt<200 & region==4,c("expt","cond","region","rt"))
subset(rt_data,rt<200 & region==5,c("expt","cond","region","rt"))
subset(rt_data,rt<200 & region==6,c("expt","cond","region","rt"))

subset(rt_data,rt>3000 & region==1,c("expt","cond","region","rt"))
subset(rt_data,rt>3000 & region==2,c("expt","cond","region","rt"))
subset(rt_data,rt>3000 & region==3,c("expt","cond","region","rt"))
subset(rt_data,rt>3000 & region==4,c("expt","cond","region","rt"))
subset(rt_data,rt>3000 & region==5,c("expt","cond","region","rt"))
subset(rt_data,rt>3000 & region==6,c("expt","cond","region","rt"))

tapply(rt_data$rt, rt_data$region, mean)
tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)
```

rt trimming

```{r}
rt_data_notrim <- rt_data

rt_data<-subset(rt_data_notrim,rt>=lowerboundRT & rt<=upperboundRT)

```

Generate z-scores for variable A using the scale() function
scale(A, center = TRUE, scale = TRUE)

Be aware that this z-score computation per region x cond cell is { before / after } the yes/no trimming.

```{r}
myRT <- c()
newdataframe <- c()
for(i in unique(rt_data$region)){   
  for(j in unique(rt_data$cond)){
    # abstract rt column in the region x cond cell
    myRT <- subset(rt_data, region==i & cond==j);
    # compute z-score
    myRT$RxCzs <- scale(myRT$rt, center = T, scale = T);
    # 蓄積
    newdataframe<-rbind(newdataframe,myRT);
    }
}; 

rt_data <- merge(rt_data,newdataframe,all=T)

```

##### check outliers
```{r}
bs <- rt_data[which(rt_data$RxCzs >3),]
bs <- bs[c("subj","item","region","cond","rt","RxCzs")]
bs[order(bs$region,bs$cond,bs$RxCzs),]
```

```{r}
bs <- rt_data[which(rt_data$RxCzs >5),]
bs <- bs[c("subj","item","region","cond","rt","RxCzs")]
bs[order(bs$region,bs$cond,bs$RxCzs),]
```


##### rt trimming based on RxCzs
```{r}
tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)

rt_data<-subset(rt_data,RxCzs<trimRxCzs)

tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean)
mean(subset(rt_data,region==5&cond=="h")$rt)

```

##### log transform
```{r}
ifelse(tf=="log",rt_data$rt<-log(rt_data$rt),
       ifelse(tf=="log10",rt_data$rt<-log10(rt_data$rt),
              ifelse(tf=="negreciprocal",rt_data$rt<- -1000/rt_data$rt,tf<-"none")))

if(tf!="none"){ tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean) }

ifelse(tf=="log",RTlabel<-"Log-transformed RTs",
       ifelse(tf=="log10",RTlabel<-"Log_10-transformed RTs",
              ifelse(tf=="negreciprocal",RTlabel<-"Neg-reciprocal RTs",RTlabel<-"RTs(ms)")))



if(tf!="none"){ tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean) }
```


##### choose spillover in accordance of the choice log transformation 
```{r}
# First, change the value of spilloverraw under lowerboundRT to the value of lowerboundRT because we do not overestimate the negative spillover effects
rt_data$spilloverraw[rt_data$spilloverraw<lowerboundRT]<-lowerboundRT

ifelse(tf=="log",rt_data$spillover<-log(rt_data$spilloverraw),
       ifelse(tf=="log10",rt_data$spillover<-log10(rt_data$spilloverraw),
              ifelse(tf=="negreciprocal",rt_data$spillover<- -1000/rt_data$spillover,rt_data$spillover<-rt_data$spilloverraw)))

head(rt_data) %>%
  dplyr::select(subj,expt,item,cond,region,rt,spilloverraw,spillover) 


# centering
ifelse(spilloverztransform == 1,
       rt_data$spillover<-scale(rt_data$spillover, center=T, scale=T),
       ifelse(spillovercentering == 1, 
              rt_data$spillover <- scale(rt_data$spillover, center=T, scale=F),
              rt_data$spillover <- rt_data$spillover))

head(rt_data) %>%
  dplyr::select(subj,expt,item,cond,region,rt,spilloverraw,spillover) 



#if(tf!="none"){ tapply(rt_data$rt, paste(rt_data$region, rt_data$cond), mean) }
```


## Summary (interim)

のちにtrimmingをする（かもしれない）ので，このファイルの最後でもういちどサマリーとプロットの最終盤を生成します。

##### Extract data for summary

###### Critical region plus 3
```{r}
rtg <- subset(rt_data,region<=criticalregion+crplus)

```

##### better comprehender?
```{r}
# rtg$ExptCAmedian
# rtg$ExptCAmean
# rtg <- subset(rtg,SubjExptCA>=ExptCAmedian)
```


##### summary

```{r}
# Raw rt version
rt_data_summary <- ddply(rtg, .(cond,region), summarise, N=length(rt), mean=mean(rt), sd=sd(rt), se=sd/sqrt(N),ci=qt(0.975,df=N-1)*se)
```

##### Coding conditions for plot labels
```{r}
rt_data_summary$A<-ifelse(rt_data_summary$cond%in%c("Cr","Cs"),"Non-durative","Durative")
rt_data_summary$B<-ifelse(rt_data_summary$cond%in%c("Cr","Dr"),"Reduplicated","Simple")
rt_data_summary$Conditions<-paste(rt_data_summary$A,rt_data_summary$B,sep=":")
rt_data_summary$B

# Change the order of the legend labels
if( revorderA == 1 ){  
  rt_data_summary$A<-factor(rt_data_summary$A, levels=rev(levels(factor(rt_data_summary$A))))}
if( revorderB == 1 ){  
  rt_data_summary$B<-factor(rt_data_summary$B, levels=rev(levels(factor(rt_data_summary$B))))
}

# Factor labels in the plots
Alabel<-"Temp Adverb"  
Blabel<-"Onomatopoeia"  

rt_data_summary
#rrt_data_summary
```


## Plots

See the following references for ggplot codes:

http://www.cookbook-r.com/Graphs/Shapes_and_line_types/

http://meme.biology.tohoku.ac.jp/students/iwasaki/rstats/ggplot2.html


##### Mean RTs
Base
```{r}
g <- ggplot(rt_data_summary,aes(x=region,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(linetype=A))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Alabel)
```

Add points
```{r}
g <- g + geom_point(size=5,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(22,21,24,25))
g <- g + scale_fill_manual(values=c("black","white","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.3)
```

Adjust x-axis breaks
```{r}
g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 0.8) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Region", y=RTlabel)
print(g)
```

##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(22,21,24,25))
g <- g + scale_fill_manual(values=c("black","white","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal adverb", y=RTlabel)
print(g)
```




##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion+1)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(22,21,24,25))
g <- g + scale_fill_manual(values=c("black","white","white","black"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal abverb", y=RTlabel)
print(g)
```



##### Interaction
Base
```{r}
rtg <- subset(rt_data_summary,region==criticalregion+2)
g <- ggplot(rtg,aes(x=A,y=mean,group=Conditions))
```

Add lines
```{r}
g <- g + geom_line(size=1,aes(group=B,linetype=B))
g <- g + scale_linetype_manual(values=c("dotdash","solid"))
g <- g + labs(linetype=Blabel)
```

Add points
```{r}
g <- g + geom_point(size=8,aes(shape=B,fill=B))
g <- g + scale_shape_manual(values=c(22,21,24,25))
g <- g + scale_fill_manual(values=c("black","white","black","white"))
g <- g + labs(shape=Blabel)
g <- g + labs(fill=Blabel)
```

Add error bars
```{r}
g <- g + geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci), width=.1)
```

Adjust x-axis breaks
```{r}
#g <- g + scale_x_continuous(breaks=seq(1, 10, by=1))
```

Adjust appearance
```{r}
g <- g + theme_classic(base_size=20, base_family="HiraKakuProN-W3")
g <- g + theme_classic(base_size=20, base_family="Times")
g <- g + theme(aspect.ratio = 1) #Ratio of y-bar to x-bar=1
g <- g + labs(x="Temporal adverb", y=RTlabel)
print(g)
```




### Analysis 



Coding factors 
-------------------------------

##### CONDITIONS:

```{r}
rt_data$Adv<-ifelse(rt_data$cond%in%c("Dr","Ds"),0.5,-0.5)
rt_data$Onom<-ifelse(rt_data$cond%in%c("Ds","Cs"),0.5,-0.5)

# For pairwise comparisons
rt_data$simpleVSredup_dur <-ifelse(rt_data$Adv==0.5,
                          ifelse(rt_data$Onom==0.5,0.5,-0.5),
                          0)
rt_data$simpleVSredup_nondur <-ifelse(rt_data$Adv==-0.5,
                          ifelse(rt_data$Onom==0.5,0.5,-0.5),
                          0)
rt_data$durVSnondur_simple <-ifelse(rt_data$Onom==0.5,
                          ifelse(rt_data$Adv==0.5,0.5,-0.5),
                          0)
rt_data$durVSnondur_redup <-ifelse(rt_data$Onom==-0.5,
                          ifelse(rt_data$Adv==0.5,0.5,-0.5),
                          0)



```

rt_data check
```{r}
dc <- subset(rt_data,cond=="Cr",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Cs",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Dr",c(cond,word,Adv,Onom))
head(dc, n=7)
dc <- subset(rt_data,cond=="Ds",c(cond,word,Adv,Onom))
head(dc, n=7)

```




##### Make sure factors are treated as factors
```{r}
rt_data$subj<-factor(rt_data$subj)
rt_data$expt<-factor(rt_data$expt)
rt_data$item<-factor(rt_data$item)
rt_data$cond<-factor(rt_data$cond)
rt_data$word<-factor(rt_data$word)
```

#### Critical(Onomatopoeia) region 
```{r}
cregion<-subset(rt_data,region==criticalregion)
```

##### Check words
```{r}
sort(unique(cregion$word))
```


##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

```




#### Verb region
```{r}
cregion<-subset(rt_data,region==criticalregion+1)
```

##### Check words
```{r}
sort(unique(cregion$word))
```


##### Max model


```{r}
#mm<-lmer(rt~Adv+Onom+Adv:Onom+spillover+
           #(1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           #control=lmerControl(optimizer="bobyqa"),
           #cregion)
#summary(mm)

mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)


```


##### Post hoc multiple pairwise comparisons to test the interaction
```{r}
mmm<-lmer(rt~simpleVSredup_dur+simpleVSredup_nondur+Adv+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mmm)
```

```{r}
mmm<-lmer(rt~durVSnondur_simple+durVSnondur_redup+Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mmm)


```


#### Spillover region
```{r}
cregion<-subset(rt_data,region==criticalregion+2)
```

##### Check words
```{r}
sort(unique(cregion$word))
```


##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+
           (1+Adv+Onom+Adv:Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

```



##### Max model


```{r}
mm<-lmer(rt~Adv+Onom+Adv:Onom+spillover+
           (1+Adv+Onom|subj)+(1+Adv+Onom+Adv:Onom|item),
           control=lmerControl(optimizer="bobyqa"),
           cregion)
summary(mm)

```



